<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Magical Birthday Wish</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* Starry Background */
        body::before {
            content: "";
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px),
                radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px),
                radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px);
            background-size: 550px 550px, 350px 350px, 250px 250px;
            background-position: 0 0, 40px 60px, 130px 270px;
            z-index: 0;
            opacity: 0.6;
        }

        canvas { display: block; position: absolute; top: 0; left: 0; z-index: 1; }
        
        /* UI OVERLAYS */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 10; pointer-events: none;
            display: flex; justify-content: center; align-items: center;
            flex-direction: column;
        }

        /* BOX STYLES */
        .glass-box {
            background: rgba(20, 20, 30, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 0 30px rgba(0, 255, 255, 0.2);
            padding: 40px;
            border-radius: 20px;
            text-align: center;
            color: white;
            pointer-events: auto;
            max-width: 90%;
            width: 400px;
            display: none;
            animation: float 6s ease-in-out infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        h1 { margin-top: 0; color: cyan; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px cyan; }
        p { color: #ccc; line-height: 1.5; }

        input {
            width: 80%; padding: 12px; margin: 15px 0;
            background: rgba(255, 255, 255, 0.1); border: 1px solid #555; color: white;
            border-radius: 8px; text-align: center; font-size: 1.2rem;
        }
        input:focus { outline: none; border-color: cyan; background: rgba(255, 255, 255, 0.2); }

        /* BUTTONS */
        .btn-main {
            background: linear-gradient(45deg, #ff0055, #ff00ff);
            border: none; padding: 15px 35px; color: white;
            font-size: 1rem; border-radius: 30px; cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(255, 0, 255, 0.4);
            margin-top: 10px;
        }
        .btn-main:hover { transform: scale(1.05) translateY(-2px); box-shadow: 0 10px 25px rgba(255, 0, 255, 0.6); }

        .btn-secondary {
            background: transparent; border: 1px solid cyan; color: cyan;
            padding: 10px 20px; border-radius: 20px; margin-top: 10px; cursor: pointer;
        }
        .btn-secondary:hover { background: cyan; color: black; }

        .link-display {
            margin-top: 20px; word-break: break-all;
            font-size: 0.9rem; color: #00ffaa;
            background: rgba(0,0,0,0.5); padding: 15px; border-radius: 8px;
            display: none; user-select: text; border: 1px dashed #00ffaa;
        }

        /* CONTROLS */
        #controls {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            z-index: 20; display: none;
        }
        .icon-btn {
            background: rgba(255,255,255,0.1); border: none; color: white;
            font-size: 24px; padding: 10px 15px; border-radius: 50%;
            cursor: pointer; margin: 0 10px; transition: 0.2s;
        }
        .icon-btn:hover { background: rgba(255,255,255,0.3); }

        .input_video { display: none; }
    </style>
</head>
<body>

    <div id="ui-layer">
        
        <div id="creator-box" class="glass-box">
            <h1>‚ú® Craft A Wish ‚ú®</h1>
            <p>Enter the birthday person's name to generate a magical 3D experience just for them.</p>
            <input type="text" id="nameInput" placeholder="Name (e.g. Sarah)" maxlength="12">
            <br>
            <button class="btn-main" onclick="generateLink()">Generate Magic Link</button>
            <div id="resultLink" class="link-display"></div>
        </div>

        <div id="intro-box" class="glass-box">
            <h1>A Gift For You</h1>
            <p>Someone sent you a magical wish.<br>Put on your headphones for the best experience.</p>
            <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 20px;">
                (Use your Mouse or Webcam to control the magic)
            </p>
            <button class="btn-main" onclick="openGift()">Open Gift üéÅ</button>
        </div>

        <div id="expired-msg" class="glass-box">
            <h1 style="color: #ff5555;">Wish Faded</h1>
            <p>This magical moment has expired in the winds of time.</p>
            <button class="btn-secondary" onclick="window.location.href = window.location.pathname">Create New Wish</button>
        </div>

        <div id="loading" style="color: white; display: none; text-align: center;">
            <div style="font-size: 2rem; margin-bottom: 10px;">üéá</div>
            Loading Magic...
        </div>
    </div>

    <div id="controls">
        <button class="icon-btn" id="musicBtn" onclick="toggleMusic()">üîä</button>
        <button class="icon-btn" id="camBtn" onclick="toggleCamera()">üì∑</button>
    </div>

    <video class="input_video"></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

<script>
    // --- CONFIGURATION ---
    // You can replace this URL with any direct MP3 link
    const MUSIC_URL = "https://cdn.pixabay.com/download/audio/2022/10/05/audio_6869e6b4c3.mp3?filename=happy-birthday-jazz-122448.mp3"; 
    
    const urlParams = new URLSearchParams(window.location.search);
    const wishName = urlParams.get('n');
    const wishTime = urlParams.get('t');
    const EXPIRATION_MINUTES = 10; // Increased to 10 mins

    const creatorBox = document.getElementById('creator-box');
    const introBox = document.getElementById('intro-box');
    const expiredMsg = document.getElementById('expired-msg');
    const loadingMsg = document.getElementById('loading');
    const controls = document.getElementById('controls');
    
    let isWishMode = false;
    let finalName = "YOU";
    let audio = new Audio(MUSIC_URL);
    audio.loop = true;
    let cameraActive = false;

    // --- 0. PAGE LOGIC ---
    function initPage() {
        if (!wishName || !wishTime) {
            // Creator Mode
            creatorBox.style.display = 'block';
        } else {
            // Recipient Mode
            const now = Date.now();
            const createdTime = parseInt(wishTime);
            const diffMinutes = (now - createdTime) / 1000 / 60;

            if (diffMinutes > EXPIRATION_MINUTES) {
                expiredMsg.style.display = 'block';
            } else {
                // Valid Wish: Show "Open Gift" box (Needed for audio autoplay policy)
                try {
                    finalName = atob(wishName);
                } catch(e) { finalName = "Friend"; }
                
                introBox.style.display = 'block';
            }
        }
    }

    function generateLink() {
        const input = document.getElementById('nameInput').value.trim();
        if(!input) return alert("Please enter a name!");
        
        const encodedName = btoa(input); 
        const now = Date.now();
        const link = `${window.location.origin}${window.location.pathname}?n=${encodedName}&t=${now}`;
        
        const resDiv = document.getElementById('resultLink');
        resDiv.style.display = 'block';
        
        // Use Native Share if available (Mobile friendly)
        if (navigator.share) {
            resDiv.innerHTML = `<button class="btn-secondary" onclick="shareNative('${link}')">Share Link Now üöÄ</button>`;
        } else {
            resDiv.innerHTML = `Copy this link:<br><a href="${link}" style="color:cyan; font-size:0.8rem;">${link}</a>`;
            navigator.clipboard.writeText(link);
            alert("Link copied to clipboard!");
        }
    }

    function shareNative(link) {
        navigator.share({
            title: 'A Magical Birthday Wish',
            text: 'I made a magical birthday wish for you! ‚ú®',
            url: link,
        }).catch(console.error);
    }

    function openGift() {
        introBox.style.display = 'none';
        loadingMsg.style.display = 'block';
        
        // Start Audio
        audio.play().catch(e => console.log("Audio requires interaction"));
        controls.style.display = 'block';

        startVisuals();
        
        // Try to start camera, but don't block if user denies
        attemptCameraStart();
    }

    function toggleMusic() {
        if(audio.paused) {
            audio.play();
            document.getElementById('musicBtn').innerText = "üîä";
        } else {
            audio.pause();
            document.getElementById('musicBtn').innerText = "üîá";
        }
    }

    function toggleCamera() {
        if(!cameraActive) {
            attemptCameraStart();
        } else {
            // Stop camera logic (simplified: just stop listening)
            cameraActive = false;
            isHandDetected = false;
            document.getElementById('camBtn').style.color = "white";
        }
    }

    // --- 1. THREE.JS VISUALS ---
    let camera, scene, renderer, particles, textMesh;
    let isHandDetected = false;
    let interactionX = 0, interactionY = 0; // Unified Interaction Coordinates

    // MOUSE TRACKING FALLBACK
    document.addEventListener('mousemove', (e) => {
        if (!isHandDetected) {
            // Map mouse to 3D space approximate
            interactionX = (e.clientX / window.innerWidth - 0.5) * 200;
            interactionY = -(e.clientY / window.innerHeight - 0.5) * 100;
        }
    });

    document.addEventListener('touchmove', (e) => {
        if (!isHandDetected && e.touches.length > 0) {
            interactionX = (e.touches[0].clientX / window.innerWidth - 0.5) * 200;
            interactionY = -(e.touches[0].clientY / window.innerHeight - 0.5) * 100;
        }
    });

    function startVisuals() {
        loadingMsg.style.display = 'none';
        scene = new THREE.Scene();
        // Removed heavy fog for clarity, added light fog
        scene.fog = new THREE.FogExp2(0x050505, 0.002);

        camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 60;

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.body.appendChild(renderer.domElement);

        createTextObject();
        createParticles();
        animate();
    }

    function createTextObject() {
        const canvas = document.createElement('canvas');
        canvas.width = 1024; canvas.height = 1024;
        const ctx = canvas.getContext('2d');

        // Glow
        ctx.shadowColor = "#FF00FF"; ctx.shadowBlur = 30;
        ctx.fillStyle = "white"; ctx.textAlign = "center"; ctx.textBaseline = "middle";

        ctx.font = "bold 80px Arial";
        ctx.fillText("HAPPY", 512, 300);

        ctx.shadowColor = "#00FFFF";
        ctx.fillText("BIRTHDAY", 512, 410);

        ctx.shadowColor = "#FFD700"; ctx.fillStyle = "#FFFACD";
        ctx.font = "bold 120px 'Segoe UI'";
        ctx.fillText(finalName.toUpperCase(), 512, 580);

        const texture = new THREE.CanvasTexture(canvas);
        const textGeo = new THREE.PlaneGeometry(80, 80);
        const textMat = new THREE.MeshBasicMaterial({ map: texture, transparent: true, opacity: 1, side: THREE.DoubleSide, blending: THREE.AdditiveBlending });
        textMesh = new THREE.Mesh(textGeo, textMat);
        textMesh.position.z = -10; 
        scene.add(textMesh);
    }

    function createParticles() {
        const particleCount = 12000; 
        const geometry = new THREE.BufferGeometry();
        const positions = []; const velocities = []; const colors = [];

        const colorPalette = [
            new THREE.Color(0xFF0055), new THREE.Color(0xFFD700),
            new THREE.Color(0x00FFFF), new THREE.Color(0xFFFFFF)
        ];

        for (let i = 0; i < particleCount; i++) {
            positions.push((Math.random()-0.5)*200, (Math.random()-0.5)*200, (Math.random()-0.5)*100);
            velocities.push(0,0,0);
            const color = colorPalette[Math.floor(Math.random() * colorPalette.length)];
            colors.push(color.r, color.g, color.b);
        }

        geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
        geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

        const material = new THREE.PointsMaterial({ size: 0.8, vertexColors: true, blending: THREE.AdditiveBlending, transparent: true, opacity: 0.9, depthWrite: false });
        particles = new THREE.Points(geometry, material);
        scene.add(particles);
    }

    function animate() {
        requestAnimationFrame(animate);
        const posAttr = particles.geometry.attributes.position;
        const posArray = posAttr.array;
        
        // Settings
        const speed = 0.12; 
        const friction = 0.94; 
        const returnStrength = 0.01; 

        // Determine Target (Mouse or Hand)
        // If hand is detected, interactionX is updated by MediaPipe
        // If not, interactionX is updated by Mouse Listener
        
        for (let i = 0; i < 12000; i++) {
            const ix = i*3; const iy = i*3+1; const iz = i*3+2;
            let vx = velocities[ix]; let vy = velocities[iy]; let vz = velocities[iz];
            let px = posArray[ix]; let py = posArray[iy]; let pz = posArray[iz];

            // ATTRACTION LOGIC (Happens if Hand detected OR Mouse moved)
            // Use a "active zone" distance check
            const dx = interactionX - px;
            const dy = interactionY - py;
            const dz = 10 - pz;
            const distSq = dx*dx + dy*dy + dz*dz;

            if (distSq < 5000) { // Only attract if close-ish to cursor/hand
                const force = 100 / (distSq + 1); 
                vx += dx * force * speed;
                vy += dy * force * speed;
                vz += dz * force * speed;
            } else {
                // Return to spiral orbit
                const angle = Date.now()*0.0002 + i*0.001;
                const radius = 35 + Math.sin(Date.now()*0.001 + i)*5;
                const tx = Math.cos(angle)*radius;
                const ty = Math.sin(angle)*(radius*0.6);
                
                vx += (tx - px) * returnStrength;
                vy += (ty - py) * returnStrength;
                vz += (-10 - pz) * returnStrength;
            }

            vx *= friction; vy *= friction; vz *= friction;
            posArray[ix] += vx; posArray[iy] += vy; posArray[iz] += vz;
            velocities[ix] = vx; velocities[iy] = vy; velocities[iz] = vz;
        }
        posAttr.needsUpdate = true;

        if(textMesh) {
            textMesh.rotation.y = Math.sin(Date.now()*0.001)*0.1;
            textMesh.position.y = Math.sin(Date.now()*0.002)*3;
        }
        renderer.render(scene, camera);
    }

    // --- 2. CAMERA HANDLING ---
    function attemptCameraStart() {
        if(cameraActive) return;

        const videoElement = document.getElementsByClassName('input_video')[0];
        const hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
        
        hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        
        hands.onResults((results) => {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                isHandDetected = true;
                const index = results.multiHandLandmarks[0][8];
                // Update the unified interaction coordinates
                interactionX = (0.5 - index.x) * 200; 
                interactionY = (0.5 - index.y) * 120;
            } else {
                isHandDetected = false;
            }
        });

        const cameraUtils = new Camera(videoElement, {
            onFrame: async () => { await hands.send({image: videoElement}); },
            width: 640, height: 480
        });

        cameraUtils.start()
            .then(() => {
                cameraActive = true;
                document.getElementById('camBtn').style.color = "#00ffaa"; // Green icon
                console.log("Camera Magic Active");
            })
            .catch(err => {
                console.log("Camera denied or error, falling back to mouse");
                document.getElementById('camBtn').style.opacity = "0.5";
            });
    }

    window.addEventListener('resize', () => {
        if(camera && renderer) {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
    });

    initPage();

</script>
</body>
</html>
